name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Navigate to project
          cd ~/PokePort_Market
          
          # Pull latest code
          git pull origin main
          
          # Update backend dependencies
          cd api
          npm install --production
          
          # Update frontend
          cd ../pokemon-frontend
          npm install
          npm run build
          
          # Remove old files and copy new ones to Nginx
          sudo rm -rf /usr/share/nginx/html/*
          sudo cp -r dist/* /usr/share/nginx/html/
          
          # Set proper permissions
          sudo chown -R www-data:www-data /usr/share/nginx/html/
          sudo chmod -R 755 /usr/share/nginx/html/
          
          # Restart Nginx to clear cache and serve new files
          sudo systemctl restart nginx
          
          # Restart backend
          pm2 restart pokeport-api
          
          echo "âœ… Deployment completed successfully!"
